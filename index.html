<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>티커별 차트</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      .chart-container {
        margin-bottom: 30px;
      }
      .btn-group {
        margin-top: 0px;
        display: flex;
        justify-content: center;
      }
      button {
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <div id="charts-root"></div>
    <script>
      fetch("tickers.json")
        .then((response) => response.json())
        .then((data) => {
          const tickers = data.tickers;
          tickers.forEach((ticker) => {
            fetch(`tickers/${ticker}.json`)
              .then((response) => response.json())
              .then((tickerData) => {
                const container = document.createElement("div");
                container.className = "chart-container";
                container.innerHTML = `
            <h3 style="text-align:center;">${tickerData.name}</h3>
            <div id="chart-${ticker}"></div>
            <div class="btn-group">
              <button onclick="updateChart('${ticker}', '3m')">3m</button>
              <button onclick="updateChart('${ticker}', '6m')">6m</button>
              <button onclick="updateChart('${ticker}', '1y')">1y</button>
              <button onclick="updateChart('${ticker}', '5y')">5y</button>
              <button onclick="updateChart('${ticker}', 'all')">all</button>
            </div>
          `;
                document.getElementById("charts-root").appendChild(container);
                window.tickerData = window.tickerData || {};
                window.tickerData[ticker] = tickerData;
              });
          });
        });

      function getPeriodDates(dates, period) {
        var end = new Date(dates[dates.length - 1]);
        var start;
        if (period === "3m") {
          start = new Date(end);
          start.setMonth(end.getMonth() - 3);
        } else if (period === "6m") {
          start = new Date(end);
          start.setMonth(end.getMonth() - 6);
        } else if (period === "1y") {
          start = new Date(end);
          start.setFullYear(end.getFullYear() - 1);
        } else if (period === "5y") {
          start = new Date(end);
          start.setFullYear(end.getFullYear() - 5);
        } else {
          start = new Date(dates[0]);
        }
        return dates.filter(function (d) {
          var dt = new Date(d);
          return dt >= start && dt <= end;
        });
      }

      function updateChart(ticker, period) {
        var data = window.tickerData[ticker];
        if (!data) return;
        var dates = data.dates;
        var prices = data.prices;
        var colors = data.colors;
        var periodDates = getPeriodDates(dates, period);
        var idxStart = dates.indexOf(periodDates[0]);
        var idxEnd = dates.indexOf(periodDates[periodDates.length - 1]);
        var showDates = dates.slice(idxStart, idxEnd + 1);
        var showPrices = prices.slice(idxStart, idxEnd + 1);
        var showColors = colors.slice(idxStart, idxEnd + 1);
        var trace = {
          x: showDates,
          y: showPrices,
          mode: "lines",
          line: { color: "black" },
          marker: { color: showColors },
          name: "",
        };
        Plotly.react("chart-" + ticker, [trace], {
          title: "",
          width: 500,
          height: 400,
        });
      }

      window.onload = function () {
        setTimeout(function () {
          if (window.tickerData) {
            Object.keys(window.tickerData).forEach(function (ticker) {
              updateChart(ticker, "5y");
            });
          }
        }, 1000);
      };
    </script>
  </body>
</html>
