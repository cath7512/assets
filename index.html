<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>티커별 차트</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
        justify-items: center;
      }
      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 8px;
        min-width: 0;
      }
      .ticker-name {
        margin-bottom: 2px;
        font-weight: bold;
        font-size: 1.08em;
        text-align: center;
      }
      .chart-div {
        margin-bottom: 0px;
        border: 1.5px solid #1976d2;
        border-radius: 8px;
        box-sizing: border-box;
        width: 400px;
        height: 300px;
        background: #fff;
      }
      .period-btns {
        margin-bottom: 2px;
        margin-top: 0px;
      }
      button {
        margin: 0;
        padding: 4px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #f5f5f5;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s;
      }
      button:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="charts-grid" id="charts-root"></div>
    <script>
      fetch("tickers.json")
        .then((response) => response.json())
        .then((data) => {
          const tickers = data.tickers;
          tickers.forEach((ticker) => {
            fetch(`tickers/${ticker}.json`)
              .then((response) => response.json())
              .then((tickerData) => {
                const container = createChartContainer(ticker, tickerData.name);
                document.getElementById("charts-root").appendChild(container);
                window.tickerData = window.tickerData || {};
                window.tickerData[ticker] = tickerData;
              });
          });
        });

      function createChartContainer(ticker, name) {
        var container = document.createElement("div");
        container.className = "chart-container";

        var nameDiv = document.createElement("div");
        nameDiv.className = "ticker-name";
        nameDiv.innerText = name;
        container.appendChild(nameDiv);

        var chartDiv = document.createElement("div");
        chartDiv.id = "chart-" + ticker;
        chartDiv.className = "chart-div";
        container.appendChild(chartDiv);

        var btnDiv = document.createElement("div");
        btnDiv.className = "period-btns";
        ["1M", "3M", "6M", "1Y", "MAX"].forEach(function (period) {
          var btn = document.createElement("button");
          btn.innerText = period;
          btn.onclick = function () {
            updateChart(ticker, period);
          };
          btnDiv.appendChild(btn);
        });
        container.appendChild(btnDiv);

        return container;
      }

      function getPeriodDates(dates, period) {
        var end = new Date(dates[dates.length - 1]);
        var start;
        switch (period.toUpperCase()) {
          case "1M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 1);
            break;
          case "3M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 3);
            break;
          case "6M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 6);
            break;
          case "1Y":
            start = new Date(end);
            start.setFullYear(end.getFullYear() - 1);
            break;
          case "MAX":
            start = new Date(dates[0]);
            break;
          default:
            start = new Date(dates[0]);
        }
        return dates.filter(function (d) {
          var dt = new Date(d);
          return dt >= start && dt <= end;
        });
      }

      function updateChart(ticker, period) {
        var data = window.tickerData[ticker];
        if (!data) return;
        var dates = data.dates;
        var prices = data.prices;
        var colors = data.colors;
        var periodDates = getPeriodDates(dates, period);
        var idxStart = dates.indexOf(periodDates[0]);
        var idxEnd = dates.indexOf(periodDates[periodDates.length - 1]);
        var showDates = dates.slice(idxStart, idxEnd + 1);
        var showPrices = prices.slice(idxStart, idxEnd + 1);
        var showColors = colors.slice(idxStart, idxEnd + 1);

        // 구간별 색상 trace 분리
        var traces = [];
        var currentColor = null;
        var segX = [];
        var segY = [];
        for (var i = 0; i < showDates.length; i++) {
          var color = showColors[i];
          if (color !== currentColor && segX.length > 0) {
            traces.push({
              x: segX,
              y: segY,
              mode: "lines",
              line: { color: currentColor, width: 2 },
              name: currentColor,
            });
            segX = [];
            segY = [];
          }
          currentColor = color;
          segX.push(showDates[i]);
          segY.push(showPrices[i]);
        }
        if (segX.length > 0) {
          traces.push({
            x: segX,
            y: segY,
            mode: "lines",
            line: { color: currentColor, width: 2 },
            name: currentColor,
          });
        }

        Plotly.react("chart-" + ticker, traces, {
          title: "",
          width: 400,
          height: 300,
          showlegend: false,
          margin: { t: 24, l: 32, r: 16, b: 32 },
          paper_bgcolor: "#fff",
        });
      }

      window.onload = function () {
        setTimeout(function () {
          if (window.tickerData) {
            Object.keys(window.tickerData).forEach(function (ticker) {
              updateChart(ticker, "5y");
            });
          }
        }, 1000);
      };
    </script>
  </body>
</html>
