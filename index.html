<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>티커별 차트</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
        justify-items: center;
      }
      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 8px;
        min-width: 0;
      }
      .ticker-name {
        margin-bottom: 2px;
        font-weight: bold;
        font-size: 1.08em;
        text-align: center;
      }
      .chart-div {
        margin-bottom: 4px;
        border: 1.5px solid #1976d2;
        border-radius: 8px;
        box-sizing: border-box;
        width: 400px;
        height: 300px;
        background: #fff;
        /* 네 면 모두 파란색 윤곽선 */
        border-top: 1.5px solid #1976d2;
        border-right: 1.5px solid #1976d2;
        border-bottom: 1.5px solid #1976d2;
        border-left: 1.5px solid #1976d2;
      }
      .period-btns {
        margin-bottom: 2px;
        margin-top: 2px;
      }
      button {
        margin: 0 1px;
        padding: 3px 9px;
        border-radius: 5px;
        border: 1px solid #ccc;
        background: #f5f5f5;
        cursor: pointer;
        font-size: 0.92rem;
        transition: background 0.2s;
      }
      button:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="charts-grid" id="charts-root"></div>
    <script>
      fetch("tickers.json")
        .then((response) => response.json())
        .then((data) => {
          const tickers = data.tickers;
          const keyIndices = data["key indices"];
          // key indices 차트 먼저 생성
          Promise.all(
            keyIndices.map((ticker) =>
              fetch(`tickers/${ticker}.json`).then((r) => r.json())
            )
          ).then((keyDataArr) => {
            // key indices 차트 컨테이너 생성
            var container = document.createElement("div");
            container.className = "chart-container";
            var nameDiv = document.createElement("div");
            nameDiv.className = "ticker-name";
            nameDiv.innerText = "Key Indices";
            container.appendChild(nameDiv);
            var chartDiv = document.createElement("div");
            chartDiv.id = "chart-key-indices";
            chartDiv.className = "chart-div";
            container.appendChild(chartDiv);
            var chartsRoot = document.getElementById("charts-root");
            if (chartsRoot.firstChild) {
              chartsRoot.insertBefore(container, chartsRoot.firstChild);
            } else {
              chartsRoot.appendChild(container);
            }
            // 차트 데이터 준비 (null 값 제거)
            var traces = [];
            function filterValidMonthly(d) {
              var arr = [];
              for (var i = 0; i < d.prices.length; i++) {
                if (
                  d.prices[i] !== null &&
                  !isNaN(d.prices[i]) &&
                  /^\d{4}-\d{2}-01$/.test(d.dates[i])
                ) {
                  arr.push({ date: d.dates[i], price: d.prices[i] });
                }
              }
              return arr;
            }
            if (keyDataArr.length > 0) {
              var arr0 = filterValidMonthly(keyDataArr[0]);
              if (arr0.length > 1) {
                traces.push({
                  x: arr0.map((e) => e.date),
                  y: arr0.map((e) => e.price),
                  mode: "lines",
                  line: { width: 2 },
                  name: keyDataArr[0].name || keyIndices[0],
                  yaxis: "y",
                });
              }
            }
            if (keyDataArr.length > 1) {
              var arr1 = filterValidMonthly(keyDataArr[1]);
              if (arr1.length > 1) {
                traces.push({
                  x: arr1.map((e) => e.date),
                  y: arr1.map((e) => e.price),
                  mode: "lines",
                  line: { width: 2 },
                  name: keyDataArr[1].name || keyIndices[1],
                  yaxis: "y2",
                });
              }
            }
            if (keyDataArr.length > 2) {
              var arr2 = filterValidMonthly(keyDataArr[2]);
              if (arr2.length > 1) {
                traces.push({
                  x: arr2.map((e) => e.date),
                  y: arr2.map((e) => e.price),
                  mode: "lines",
                  line: { width: 2 },
                  name: keyDataArr[2].name || keyIndices[2],
                  yaxis: "y3",
                });
              }
            }
            Plotly.newPlot("chart-key-indices", traces, {
              title: "",
              width: 400,
              height: 300,
              showlegend: true,
              margin: { t: 24, l: 32, r: 16, b: 32 },
              paper_bgcolor: "#fff",
              xaxis: { title: "날짜" },
              yaxis: {
                title: keyDataArr[0]?.name || keyIndices[0],
                titlefont: { color: "#1f77b4" },
                tickfont: { color: "#1f77b4" },
              },
              yaxis2: {
                title: keyDataArr[1]?.name || keyIndices[1],
                titlefont: { color: "#ff7f0e" },
                tickfont: { color: "#ff7f0e" },
                overlaying: "y",
                side: "right",
                position: 1,
              },
              yaxis3: {
                title: keyDataArr[2]?.name || keyIndices[2],
                titlefont: { color: "#2ca02c" },
                tickfont: { color: "#2ca02c" },
                overlaying: "y",
                side: "right",
                position: 0.95,
              },
            });
          });
          // 나머지 개별 티커 차트 생성
          tickers.forEach((ticker) => {
            fetch(`tickers/${ticker}.json`)
              .then((response) => response.json())
              .then((tickerData) => {
                const container = createChartContainer(ticker, tickerData.name);
                document.getElementById("charts-root").appendChild(container);
                window.tickerData = window.tickerData || {};
                window.tickerData[ticker] = tickerData;
              });
          });
        });

      function createChartContainer(ticker, name) {
        var container = document.createElement("div");
        container.className = "chart-container";

        var nameDiv = document.createElement("div");
        nameDiv.className = "ticker-name";
        nameDiv.innerText = name;
        container.appendChild(nameDiv);

        var chartDiv = document.createElement("div");
        chartDiv.id = "chart-" + ticker;
        chartDiv.className = "chart-div";
        container.appendChild(chartDiv);

        var btnDiv = document.createElement("div");
        btnDiv.className = "period-btns";
        ["1M", "3M", "6M", "1Y", "5Y", "10Y", "MAX"].forEach(function (period) {
          var btn = document.createElement("button");
          btn.innerText = period;
          btn.onclick = function () {
            updateChart(ticker, period);
          };
          btnDiv.appendChild(btn);
        });
        container.appendChild(btnDiv);

        return container;
      }

      function getPeriodDates(dates, period) {
        var end = new Date(dates[dates.length - 1]);
        var start;
        switch (period.toUpperCase()) {
          case "1M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 1);
            break;
          case "3M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 3);
            break;
          case "6M":
            start = new Date(end);
            start.setMonth(end.getMonth() - 6);
            break;
          case "1Y":
            start = new Date(end);
            start.setFullYear(end.getFullYear() - 1);
            break;
          case "5Y":
            start = new Date(end);
            start.setFullYear(end.getFullYear() - 5);
            break;
          case "10Y":
            start = new Date(end);
            start.setFullYear(end.getFullYear() - 10);
            break;
          case "MAX":
            start = new Date(dates[0]);
            break;
          default:
            start = new Date(dates[0]);
        }
        return dates.filter(function (d) {
          var dt = new Date(d);
          return dt >= start && dt <= end;
        });
      }

      // 개별 티커 차트도 매월 1일자만 표시하도록 updateChart 함수 수정
      function updateChart(ticker, period) {
        var data = window.tickerData[ticker];
        if (!data) return;
        var dates = data.dates;
        var prices = data.prices;
        var colors = data.colors;
        // 매월 1일자만 필터링
        var monthlyIdx = dates
          .map((d, i) => (/^\d{4}-\d{2}-01$/.test(d) ? i : -1))
          .filter((i) => i !== -1);
        var monthlyDates = monthlyIdx.map((i) => dates[i]);
        var monthlyPrices = monthlyIdx.map((i) => prices[i]);
        var monthlyColors = monthlyIdx.map((i) => colors[i]);
        var periodDates = getPeriodDates(monthlyDates, period);
        var idxStart = monthlyDates.indexOf(periodDates[0]);
        var idxEnd = monthlyDates.indexOf(periodDates[periodDates.length - 1]);
        var showDates = monthlyDates.slice(idxStart, idxEnd + 1);
        var showPrices = monthlyPrices.slice(idxStart, idxEnd + 1);
        var showColors = monthlyColors.slice(idxStart, idxEnd + 1);

        // 구간별 색상 trace 분리
        var traces = [];
        var currentColor = null;
        var segX = [];
        var segY = [];
        for (var i = 0; i < showDates.length; i++) {
          var color = showColors[i];
          if (color !== currentColor && segX.length > 0) {
            traces.push({
              x: segX,
              y: segY,
              mode: "lines",
              line: { color: currentColor, width: 2 },
              name: currentColor,
            });
            segX = [];
            segY = [];
          }
          currentColor = color;
          segX.push(showDates[i]);
          segY.push(showPrices[i]);
        }
        if (segX.length > 0) {
          traces.push({
            x: segX,
            y: segY,
            mode: "lines",
            line: { color: currentColor, width: 2 },
            name: currentColor,
          });
        }

        Plotly.react("chart-" + ticker, traces, {
          title: "",
          width: 400,
          height: 300,
          showlegend: false,
          margin: { t: 24, l: 32, r: 16, b: 32 },
          paper_bgcolor: "#fff",
        });
      }

      window.onload = function () {
        setTimeout(function () {
          if (window.tickerData) {
            Object.keys(window.tickerData).forEach(function (ticker) {
              updateChart(ticker, "5y");
            });
          }
        }, 1000);
      };
    </script>
  </body>
</html>
